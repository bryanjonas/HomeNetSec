# HomeNetSec

HomeNetSec is a dockerized home network security pipeline packaged as an OpenClaw *skill source repo*.

It produces a daily report by combining:
- **PCAP-based network telemetry** (offline Zeek analysis)
- **TLS fingerprint telemetry** (offline Suricata → EVE JSON)
- **DNS telemetry** (AdGuard Home stats)
- **Behavioral enrichment** (RITA beacon/long-connection analysis)
- **Baselines & anomaly candidates** (local SQLite state)

The design is intentionally modular so you can swap out **how PCAPs arrive** (OPNsense, tcpdump, SPAN port, etc.) without rewriting analysis/reporting.

## Current design (important)

HomeNetSec is split into **two pipelines** that can be scheduled independently:

1) **Download + processing pipeline** (PCAP ingest → merge → Suricata + Zeek)
2) **Analysis + dashboard pipeline** (RITA/reporting → triage digest → dashboard update)

You can also run a **single “full pipeline”** schedule that runs both back-to-back.

### A) Download + processing pipeline (recommended cadence: hourly)

Entry point:
- `scripts/hourly_ingest_merge_process.sh`

**Goal:** keep PCAP processing incremental and avoid spinning up containers for each tiny PCAP.

What it does:
1. Downloads **eligible new PCAPs since the last contiguous ingest** (tracked via `output/state/hourly_ingest_state.json`). This state is *gap-safe*: it retains a retry list of missing/failed segments so older uncopied files are still fetched later.
2. Applies **partial protections**:
   - skips newest `PULL_SKIP_NEWEST_N` remote files (default: 1)
   - ignores anything newer than `now - SAFETY_LAG_SECONDS` (default: 120s)
3. Merges that batch into one PCAP via `mergecap`.
4. Verifies the merge (packet count of merged PCAP equals sum of inputs) and retries once if needed.
5. Deletes the source PCAP files after a verified merge.
6. Runs **Suricata + Zeek** on the merged PCAP.

Retention defaults:
- merged PCAPs: **7 days**
- Suricata EVE outputs + Zeek logs from merged runs: **30 days**

### B) Analysis + dashboard pipeline (recommended cadence: 2×/day or hourly)

This pipeline does **not** pull PCAPs and does **not** rerun Zeek/Suricata. It consumes the Zeek outputs from the download/processing pipeline.

Typical command sequence:
- `env SKIP_PCAP_PULL=1 SKIP_ZEEK=1 RUN_JA4=0 ./scripts/run_daily.sh YYYY-MM-DD`
- `./scripts/triage_digest.py --day YYYY-MM-DD --workdir "$HOMENETSEC_WORKDIR"`
- `./scripts/generate_dashboard.sh YYYY-MM-DD`

### C) Full pipeline (ingest + analysis + dashboard)

If you want everything updated together, run:
1) `scripts/hourly_ingest_merge_process.sh`
2) then the analysis + dashboard pipeline above

## What this does (high level)

- Download/processing: PCAP ingest → merge → Suricata + Zeek
- Analysis/dashboard: RITA + baselines/candidates → triage digest → dashboard

## Repo / skill layout

- `SKILL.md` — OpenClaw skill metadata + minimal usage notes
- `scripts/hourly_ingest_merge_process.sh` — hourly ingest (download new pcaps, merge, verify, delete inputs, Suricata+Zeek on merged)
- `scripts/run_daily.sh` — report generator (RITA + baselines + candidates + report; can optionally run full pull/zeek if enabled)
- `scripts/run_and_send_openclaw.sh` — OpenClaw wrapper (optionally run ingest + analysis, then send Telegram)
- `scripts/pull_recent_pcaps.sh` — helper: pull last N hours worth of pcaps (kept for debugging)
- `assets/docker-compose.yml` — Zeek + RITA + Mongo + Suricata stack
- `assets/rita-config.yaml.example` — example RITA config
- `references/` — supporting docs

Runtime outputs are not committed (PCAPs/logs/reports/DB).

## How DNS + PCAP are wired (in my setup)

This pipeline assumes two independent inputs:

### PCAP input (network traffic)

In my setup, PCAPs are generated by a firewall/router and periodically pulled onto the machine running HomeNetSec. The pipeline then processes those PCAPs offline.

**Important:** the rest of the pipeline does *not* care *where* PCAPs come from, only that they appear on disk in the expected folder structure.

Expected path:

- `$HOMENETSEC_WORKDIR/pcaps/YYYY-MM-DD/lan-YYYY-MM-DD_*.pcap*`

The default `run_daily.sh` includes a pull step tailored to my environment (SFTP pull from an OPNsense host; supports non-interactive SSH accounts without shell access). If you don’t have that, you can:

- disable/replace the pull step, and
- just drop your PCAPs into the folder above.

### DNS input (resolver telemetry)

DNS telemetry is collected from **AdGuard Home** via its HTTP API.

Expected configuration is provided via environment variables (or a sourced env file):
- `ADGUARD_URL`
- `ADGUARD_USER`
- `ADGUARD_PASS`

This is used only for summary stats in the report (e.g., top clients, top blocked domains). It is not required to run PCAP/Zeek/RITA.

## Configuration

### Environment file (.env)

All scripts automatically source `.env` from the repo root if present. Copy the example and customize:

```bash
cp .env.example .env
# Edit .env with your paths
```

The `.env` file is gitignored — keep your local configuration there.

### Core environment variables

- `HOMENETSEC_WORKDIR` — where PCAPs/logs/reports live (default: `./output`)

### Dashboard environment variables

- `HOMENETSEC_LAN_BIND_IP` — LAN IP to bind dashboard (required for dashboard)
- `HOMENETSEC_TS_BIND_IP` — Tailscale IP to bind dashboard (required for dashboard)
- `HOMENETSEC_DASHBOARD_PORT` — dashboard port (default: `8088`)
- `HOMENETSEC_DASHBOARD_BASE_URL` — base URL for dashboard links (optional)

**Running the dashboard:**

```bash
cd HomeNetSec
docker compose --env-file .env -f assets/dashboard-compose.yml up -d
```

### OPNsense PCAP ingest (environment-specific)

HomeNetSec pulls PCAPs using **SFTP** (not remote shell commands), which allows use of locked-down SSH accounts (no interactive shell).

Required env vars (recommend storing in an uncommitted file like `~/.openclaw/credentials/opnsense.env` and sourcing it in cron):

- `OPNSENSE_HOST` (required)
- `OPNSENSE_USER`
- `OPNSENSE_KEY` (path to SSH private key)
- `OPNSENSE_PCAP_DIR`

### Hourly ingest controls

- `PULL_SKIP_NEWEST_N` — skip newest N remote PCAP files when pulling (default: `1`)
- `SAFETY_LAG_SECONDS` — ignore files newer than `now - lag` (default: `120`)
- `MERGE_RETRIES` — retries for merge+verify (default: `1`)
- `VERIFY_MERGE` — verify merged packet counts (default: `1`)
- `DELETE_MERGED_INPUTS` — delete per-ingest raw PCAPs after verified merge (default: `1`)
- Retention:
  - `MERGED_PCAP_RETENTION_DAYS` (default: `7`)
  - `HOURLY_ARTIFACT_RETENTION_DAYS` (default: `30`)
  - `RUN_RETENTION_CLEANUP` (default: `1`)

### Reporting/digest controls

`run_and_send_openclaw.sh` runs `run_daily.sh` in *report-only mode* (no extra PCAP pull and no extra Zeek/Suricata pass).
You can override by running `run_daily.sh` directly.

### Pipeline toggles (used by run_daily.sh)

- `RUN_RITA` — set to `0` to skip RITA (default: `1`)
- `RUN_JA4` — set to `0` to skip Suricata TLS fingerprint extraction when running full pipeline (default: `1`)
- `SKIP_PCAP_PULL` — set to `1` to avoid pulling from OPNsense (use local pcaps)
- `SKIP_ZEEK` — set to `1` to skip Zeek processing
- `SKIP_FLATTEN` — set to `1` to skip Zeek-flatten step

### AdGuard Home (optional)

- `ADGUARD_ENV` — path to an env file with `ADGUARD_URL/USER/PASS`
  - default: `~/.openclaw/credentials/adguard.env`

## Running

### Hourly ingest (download new pcaps, merge, Suricata+Zeek)

```bash
cd HomeNetSec
export HOMENETSEC_WORKDIR="$PWD/output"
./scripts/hourly_ingest_merge_process.sh
```

### Analysis pipeline (RITA + triage digest + dashboard)

```bash
cd HomeNetSec
export HOMENETSEC_WORKDIR="$PWD/output"
DAY="$(TZ=America/New_York date +%F)"

# reporting + RITA (does NOT pull pcaps; does NOT run Zeek)
env SKIP_PCAP_PULL=1 SKIP_ZEEK=1 RUN_JA4=0 ./scripts/run_daily.sh "$DAY"

# deterministic triage digest enrichment
./scripts/triage_digest.py --day "$DAY" --workdir "$HOMENETSEC_WORKDIR"

# regenerate dashboard (persistent alert queue + feedback)
./scripts/generate_dashboard.sh "$DAY"
```

### Telegram delivery wrapper (optional)

If you want OpenClaw to send a Telegram update, use:

```bash
cd HomeNetSec
export HOMENETSEC_WORKDIR="$PWD/output"
./scripts/run_and_send_openclaw.sh
```

(Delivery is intentionally separated from analysis; you can run analysis on a schedule and only send messages when desired.)

### Ad-hoc: generate report for a specific day (report-only)

```bash
cd HomeNetSec
export HOMENETSEC_WORKDIR="$PWD/output"
export SKIP_PCAP_PULL=1
export SKIP_ZEEK=1
export RUN_JA4=0
./scripts/run_daily.sh 2026-02-06
```

## Modularity notes (how to adapt this to your network)

The cleanest way to adapt HomeNetSec is to treat it as layers:

1. **Ingest layer**: get PCAPs into `$HOMENETSEC_WORKDIR/pcaps/YYYY-MM-DD/` (hourly job pulls from OPNsense)
2. **Hourly analysis layer**: merge + Suricata + Zeek
3. **Reporting layer**: flatten Zeek logs + RITA + baselines/candidates + report generation
4. **Delivery layer**: send the report to your preferred destination

You can replace the ingest layer without changing the rest.

## Security & privacy

- Do **not** commit PCAPs, Zeek logs, reports, or credential files.
- Keep secrets in environment variables or external env files.
- PCAPs may contain sensitive metadata/content; handle and share with care.
