# HomeNetSec dashboard (static)
#
# This service serves files generated under $HOMENETSEC_WORKDIR/www (HTML + JSON) via a tiny nginx container.
#
# IMPORTANT:
# - Bind only to LAN + Tailscale IPs (no 0.0.0.0) so it is not exposed publicly.
# - Configuration is read from the root .env file. Run with: docker compose --env-file ../.env
#   Or run from the repo root: docker compose --env-file .env -f assets/dashboard-compose.yml

services:
  homenetsec_dashboard_api:
    image: python:3.12-alpine
    container_name: homenetsec_dashboard_api
    restart: unless-stopped
    environment:
      - HOMENETSEC_STATE_DIR=/state
      - PYTHONDONTWRITEBYTECODE=1
    volumes:
      - ${HOMENETSEC_WORKDIR:-../output}/state:/state
      - ./dashboard-api:/app:ro
    working_dir: /app
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      'pip install --no-cache-dir flask gunicorn >/dev/null &&
       exec gunicorn -w 1 -b 0.0.0.0:8000 app:app'

  homenetsec_dashboard:
    image: nginx:alpine
    container_name: homenetsec_dashboard
    restart: unless-stopped
    depends_on:
      - homenetsec_dashboard_api
    volumes:
      - ${HOMENETSEC_WORKDIR:-../output}/www:/usr/share/nginx/html:ro
      - ./dashboard-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "${HOMENETSEC_LAN_BIND_IP:?set in .env}:${HOMENETSEC_DASHBOARD_PORT:-8088}:80"
      - "${HOMENETSEC_TS_BIND_IP:?set in .env}:${HOMENETSEC_DASHBOARD_PORT:-8088}:80"
